<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lazare Trackt - Expense Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        .dark {
            color-scheme: dark;
        }
        .theme-btn {
            background: rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
        }
        .dark .theme-btn {
            background: rgba(255, 255, 255, 0.15);
        }
        .theme-btn:hover {
            background: rgba(0, 0, 0, 0.1);
            transform: scale(1.05);
        }
        .dark .theme-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen transition-colors duration-200">
    <div class="max-w-4xl mx-auto p-6">
        <!-- Header -->
        <div class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg p-6 mb-6 shadow-md">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <i data-lucide="shopping-cart" class="w-6 h-6 text-gray-900 dark:text-white"></i>
                    <h1 class="text-2xl font-semibold text-gray-900 dark:text-white">Lazare Trackt</h1>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="app.showExportMenu()" class="theme-btn p-2 rounded-lg">
                        <i data-lucide="download" class="w-5 h-5 text-gray-900 dark:text-white"></i>
                    </button>
                    <button onclick="document.getElementById('csvInput').click()" class="theme-btn p-2 rounded-lg">
                        <i data-lucide="upload" class="w-5 h-5 text-gray-900 dark:text-white"></i>
                    </button>
                    <button onclick="app.toggleTheme()" class="theme-btn p-2 rounded-lg">
                        <i data-lucide="moon" id="themeIcon" class="w-5 h-5 text-gray-900 dark:text-white"></i>
                    </button>
                </div>
            </div>
            <input type="file" id="csvInput" accept=".csv" class="hidden" onchange="app.importCSV(event)">
            
            <!-- Budget Alert -->
            <div id="budgetAlert" class="hidden mb-4 p-3 bg-yellow-100 dark:bg-yellow-900/40 border-2 border-yellow-400 dark:border-yellow-600 rounded-lg">
                <div class="flex items-center gap-2 text-yellow-900 dark:text-yellow-100">
                    <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                    <span class="text-sm font-medium" id="budgetAlertText"></span>
                </div>
            </div>
            
            <!-- Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                <div class="border-2 border-gray-300 dark:border-gray-600 rounded-lg p-4 bg-gray-50 dark:bg-gray-700/50">
                    <div class="text-sm text-gray-600 dark:text-gray-300 mb-1 font-medium">Monthly Recurring</div>
                    <div class="text-2xl font-bold text-gray-900 dark:text-white" id="monthlyTotal">$0.00</div>
                </div>
                <div class="border-2 border-gray-300 dark:border-gray-600 rounded-lg p-4 bg-gray-50 dark:bg-gray-700/50">
                    <div class="text-sm text-gray-600 dark:text-gray-300 mb-1 font-medium">Yearly Total</div>
                    <div class="text-2xl font-bold text-gray-900 dark:text-white" id="yearlyTotal">$0.00</div>
                </div>
                <div class="border-2 border-gray-300 dark:border-gray-600 rounded-lg p-4 bg-gray-50 dark:bg-gray-700/50">
                    <div class="text-sm text-gray-600 dark:text-gray-300 mb-1 font-medium">One-Time Total</div>
                    <div class="text-2xl font-bold text-gray-900 dark:text-white" id="oneTimeTotal">$0.00</div>
                </div>
                <div class="border-2 border-gray-300 dark:border-gray-600 rounded-lg p-4 bg-gray-50 dark:bg-gray-700/50">
                    <div class="text-sm text-gray-600 dark:text-gray-300 mb-1 font-medium">Total Items</div>
                    <div class="text-2xl font-bold text-gray-900 dark:text-white" id="itemCount">0</div>
                </div>
            </div>

            <!-- Budget Setter -->
            <div class="flex items-center gap-3">
                <label class="text-sm font-semibold text-gray-800 dark:text-gray-200">Monthly Budget:</label>
                <input type="number" id="budgetInput" placeholder="Set budget" step="0.01" value=""
                    onchange="app.setBudget()"
                    class="flex-1 px-3 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-medium">
                <span class="text-sm font-semibold text-gray-700 dark:text-gray-300" id="budgetRemaining"></span>
            </div>
        </div>

        <!-- Add Item Button -->
        <button onclick="app.toggleForm()" class="w-full bg-blue-600 dark:bg-blue-500 text-white py-3 px-4 rounded-lg font-semibold mb-6 hover:bg-blue-700 dark:hover:bg-blue-600 transition-colors shadow-md flex items-center justify-center gap-2">
            <i data-lucide="plus" class="w-5 h-5"></i>
            Add Item
        </button>

        <!-- Search and Filter -->
        <div class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg p-4 mb-6 shadow-md">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                <input type="text" id="searchInput" placeholder="Search items..." 
                    oninput="app.applyFilters()"
                    class="px-3 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                
                <select id="categoryFilter" onchange="app.applyFilters()" class="px-3 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    <option value="">All Categories</option>
                    <option>Entertainment</option>
                    <option>Health</option>
                    <option>Food</option>
                    <option>Utilities</option>
                    <option>Shopping</option>
                    <option>Other</option>
                </select>

                <select id="sortBy" onchange="app.applyFilters()" class="px-3 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    <option value="name">Sort by Name</option>
                    <option value="amount-high">Amount (High to Low)</option>
                    <option value="amount-low">Amount (Low to High)</option>
                    <option value="day">Day of Month</option>
                </select>
            </div>
            
            <!-- Bulk Actions Bar -->
            <div id="bulkActionsBar" class="hidden pt-3 border-t-2 border-gray-300 dark:border-gray-600">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-semibold text-gray-700 dark:text-gray-300">
                        <span id="selectedCount">0</span> items selected
                    </span>
                    <div class="flex gap-2">
                        <button onclick="app.bulkDelete()" class="px-3 py-1 bg-red-600 text-white text-sm rounded font-semibold hover:bg-red-700 transition-colors">
                            Delete Selected
                        </button>
                        <button onclick="app.clearSelection()" class="px-3 py-1 bg-gray-400 dark:bg-gray-600 text-white text-sm rounded font-semibold hover:bg-gray-500 dark:hover:bg-gray-500 transition-colors">
                            Clear
                        </button>
                    </div>
                </div>
            </div>
        </div><!-- Category Chart -->
        <div class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg p-6 mb-6 shadow-md">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold text-gray-900 dark:text-white">Spending by Category</h2>
                <div class="flex gap-2">
                    <button onclick="app.setChartType('bar')" id="barChartBtn" class="px-3 py-1 text-sm bg-blue-600 dark:bg-blue-500 text-white rounded font-semibold">
                        Bar
                    </button>
                    <button onclick="app.setChartType('pie')" id="pieChartBtn" class="px-3 py-1 text-sm bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded font-semibold">
                        Pie
                    </button>
                </div>
            </div>
            <canvas id="categoryChart" width="400" height="200"></canvas>
        </div>

        <!-- Dashboard Widgets -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Most Expensive Items -->
            <div class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg p-6 shadow-md">
                <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Top 5 Most Expensive</h2>
                <div id="topExpensiveItems" class="space-y-3"></div>
            </div>

            <!-- Spending Forecast -->
            <div class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg p-6 shadow-md">
                <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Next Month Forecast</h2>
                <div id="forecastWidget">
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Recurring Charges</span>
                            <span class="font-bold text-gray-900 dark:text-white" id="forecastRecurring">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Predicted One-Time</span>
                            <span class="font-bold text-gray-900 dark:text-white" id="forecastOneTime">$0.00</span>
                        </div>
                        <div class="pt-3 border-t-2 border-gray-300 dark:border-gray-600">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-bold text-gray-800 dark:text-gray-200">Total Forecast</span>
                                <span class="text-xl font-bold text-blue-600 dark:text-blue-400" id="forecastTotal">$0.00</span>
                            </div>
                            <p class="text-xs text-gray-600 dark:text-gray-400 mt-2" id="forecastNote"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Menu -->
        <div id="exportMenu" class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg p-4 mb-6 hidden shadow-md">
            <h3 class="text-sm font-bold text-gray-900 dark:text-white mb-3">Export Data</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <button onclick="app.exportCSV()" class="flex items-center justify-center gap-2 px-4 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-800 dark:text-gray-200 font-medium">
                    <i data-lucide="file-text" class="w-4 h-4"></i>
                    <span class="text-sm">CSV</span>
                </button>
                <button onclick="app.exportJSON()" class="flex items-center justify-center gap-2 px-4 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-800 dark:text-gray-200 font-medium">
                    <i data-lucide="code" class="w-4 h-4"></i>
                    <span class="text-sm">JSON</span>
                </button>
                <button onclick="app.exportPDF('monthly')" class="flex items-center justify-center gap-2 px-4 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-800 dark:text-gray-200 font-medium">
                    <i data-lucide="file-text" class="w-4 h-4"></i>
                    <span class="text-sm">Monthly PDF</span>
                </button>
                <button onclick="app.exportPDF('yearly')" class="flex items-center justify-center gap-2 px-4 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-800 dark:text-gray-200 font-medium">
                    <i data-lucide="file-text" class="w-4 h-4"></i>
                    <span class="text-sm">Yearly PDF</span>
                </button>
            </div>
            <div class="mt-3 pt-3 border-t-2 border-gray-300 dark:border-gray-600">
                <button onclick="document.getElementById('jsonInput').click()" class="w-full flex items-center justify-center gap-2 px-4 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-800 dark:text-gray-200 font-medium">
                    <i data-lucide="upload" class="w-4 h-4"></i>
                    <span class="text-sm">Import JSON Backup</span>
                </button>
            </div>
        </div>
        <input type="file" id="jsonInput" accept=".json" class="hidden" onchange="app.importJSON(event)">

        <!-- Add Form -->
        <div id="addForm" class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg p-6 mb-6 hidden shadow-md">
            <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-4" id="formTitle">Add New Item</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-800 dark:text-gray-200 mb-1">Item Name</label>
                    <input type="text" id="itemName" placeholder="e.g., Netflix" 
                        class="w-full px-3 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-800 dark:text-gray-200 mb-1">Amount</label>
                        <input type="number" id="itemAmount" placeholder="0.00" step="0.01"
                            class="w-full px-3 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-800 dark:text-gray-200 mb-1">Category</label>
                        <select id="itemCategory" class="w-full px-3 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <option>Entertainment</option>
                            <option>Health</option>
                            <option>Food</option>
                            <option>Utilities</option>
                            <option>Shopping</option>
                            <option>Other</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-800 dark:text-gray-200 mb-1">Type</label>
                    <select id="itemType" onchange="app.toggleDaySelector()" class="w-full px-3 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        <option value="recurring">Recurring (Monthly)</option>
                        <option value="one-time">One-Time Purchase</option>
                    </select>
                </div>

                <div id="daySelector">
                    <label class="block text-sm font-bold text-gray-800 dark:text-gray-200 mb-1">Day of Month</label>
                    <select id="itemDay" class="w-full px-3 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-800 dark:text-gray-200 mb-1">Payment Method (Optional)</label>
                    <input type="text" id="itemPayment" placeholder="e.g., Visa *1234" 
                        class="w-full px-3 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-800 dark:text-gray-200 mb-1">Notes (Optional)</label>
                    <textarea id="itemNotes" placeholder="Add notes..." rows="2"
                        class="w-full px-3 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 bg-white dark:bg-gray-700 text-gray-900 dark:text-white resize-none"></textarea>
                </div>

                <div class="flex gap-3 pt-2">
                    <button onclick="app.saveItem()" id="saveBtn" class="flex-1 bg-blue-600 dark:bg-blue-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-700 dark:hover:bg-blue-600 transition-colors">
                        Add Item
                    </button>
                    <button onclick="app.cancelForm()" class="flex-1 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-200 py-2 px-4 rounded-lg font-semibold border-2 border-gray-400 dark:border-gray-500 hover:bg-gray-400 dark:hover:bg-gray-500 transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg mb-6 shadow-md">
            <div class="flex border-b-2 border-gray-300 dark:border-gray-600">
                <button onclick="app.switchTab('recurring')" id="tabRecurring" class="flex-1 py-3 px-4 font-bold text-gray-900 dark:text-white border-b-4 border-blue-600 dark:border-blue-400">
                    Recurring
                </button>
                <button onclick="app.switchTab('one-time')" id="tabOneTime" class="flex-1 py-3 px-4 font-semibold text-gray-600 dark:text-gray-400 border-b-4 border-transparent hover:text-gray-900 dark:hover:text-white">
                    One-Time
                </button>
            </div>

            <!-- Items List -->
            <div id="itemsList" class="p-6">
            </div>
        </div>
    </div>
    <script>
        const app = {
            items: [
                { id: 1, name: 'Netflix', amount: 15.99, category: 'Entertainment', type: 'recurring', dayOfMonth: 1, payment: 'Visa *1234', notes: '' },
                { id: 2, name: 'Spotify', amount: 9.99, category: 'Entertainment', type: 'recurring', dayOfMonth: 5, payment: '', notes: '' },
                { id: 3, name: 'Laptop', amount: 1299.00, category: 'Shopping', type: 'one-time', payment: 'Master *5678', notes: 'MacBook Pro' },
                { id: 4, name: 'Gym Membership', amount: 45.00, category: 'Health', type: 'recurring', dayOfMonth: 15, payment: '', notes: '' }
            ],
            currentTab: 'recurring',
            theme: 'light',
            budget: null,
            editingId: null,
            chart: null,
            chartType: 'bar',
            selectedItems: new Set(),
            cachedStats: null,
            cachedCategoryTotals: null,
            renderTimeout: null,
            categoryIcons: {
                'Entertainment': 'üéÆ',
                'Health': 'üí™',
                'Food': 'üçî',
                'Utilities': 'üí°',
                'Shopping': 'üõçÔ∏è',
                'Other': 'üì¶'
            },

            init() {
                this.theme = this.theme || 'light';
                this.applyTheme();
                
                const daySelect = document.getElementById('itemDay');
                const fragment = document.createDocumentFragment();
                for (let i = 1; i <= 31; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `Day ${i}`;
                    fragment.appendChild(option);
                }
                daySelect.appendChild(fragment);
                
                this.invalidateCache();
                this.render();
                this.updateChart();
                this.updateDashboard();
                lucide.createIcons();
            },

            invalidateCache() {
                this.cachedStats = null;
                this.cachedCategoryTotals = null;
            },

            getStats() {
                if (this.cachedStats) return this.cachedStats;
                
                let monthlyTotal = 0;
                let oneTimeTotal = 0;
                
                for (let i = 0; i < this.items.length; i++) {
                    const item = this.items[i];
                    if (item.type === 'recurring') {
                        monthlyTotal += item.amount;
                    } else {
                        oneTimeTotal += item.amount;
                    }
                }
                
                this.cachedStats = {
                    monthlyTotal,
                    yearlyTotal: monthlyTotal * 12,
                    oneTimeTotal,
                    itemCount: this.items.length
                };
                
                return this.cachedStats;
            },

            getCategoryTotals() {
                if (this.cachedCategoryTotals) return this.cachedCategoryTotals;
                
                const totals = {};
                for (let i = 0; i < this.items.length; i++) {
                    const item = this.items[i];
                    totals[item.category] = (totals[item.category] || 0) + item.amount;
                }
                
                this.cachedCategoryTotals = totals;
                return totals;
            },

            setBudget() {
                const value = parseFloat(document.getElementById('budgetInput').value);
                this.budget = value > 0 ? value : null;
                this.checkBudgetAlert();
            },

            checkBudgetAlert() {
                const stats = this.getStats();
                const monthlyTotal = stats.monthlyTotal;
                
                const alert = document.getElementById('budgetAlert');
                const alertText = document.getElementById('budgetAlertText');
                const remaining = document.getElementById('budgetRemaining');

                if (this.budget) {
                    const diff = this.budget - monthlyTotal;
                    remaining.textContent = diff >= 0 ? `$${diff.toFixed(2)} remaining` : `$${Math.abs(diff).toFixed(2)} over budget`;
                    
                    if (monthlyTotal >= this.budget * 0.9) {
                        alert.classList.remove('hidden');
                        alertText.textContent = monthlyTotal >= this.budget 
                            ? '‚ö†Ô∏è You have exceeded your monthly budget!'
                            : '‚ö†Ô∏è You are approaching your monthly budget limit!';
                    } else {
                        alert.classList.add('hidden');
                    }
                } else {
                    remaining.textContent = '';
                    alert.classList.add('hidden');
                }
            },

            toggleTheme() {
                this.theme = this.theme === 'light' ? 'dark' : 'light';
                this.applyTheme();
                this.updateChart();
            },

            applyTheme() {
                if (this.theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    document.body.classList.remove('bg-gray-100');
                    document.body.classList.add('bg-gray-900');
                } else {
                    document.documentElement.classList.remove('dark');
                    document.body.classList.remove('bg-gray-900');
                    document.body.classList.add('bg-gray-100');
                }
                
                const icon = document.getElementById('themeIcon');
                icon.setAttribute('data-lucide', this.theme === 'light' ? 'moon' : 'sun');
                lucide.createIcons();
            },

            toggleForm() {
                const form = document.getElementById('addForm');
                const isHidden = form.classList.contains('hidden');
                
                if (isHidden) {
                    this.editingId = null;
                    this.clearForm();
                    document.getElementById('formTitle').textContent = 'Add New Item';
                    document.getElementById('saveBtn').textContent = 'Add Item';
                }
                
                form.classList.toggle('hidden');
                document.getElementById('exportMenu').classList.add('hidden');
            },

            clearForm() {
                document.getElementById('itemName').value = '';
                document.getElementById('itemAmount').value = '';
                document.getElementById('itemCategory').value = 'Entertainment';
                document.getElementById('itemType').value = 'recurring';
                document.getElementById('itemDay').value = 1;
                document.getElementById('itemPayment').value = '';
                document.getElementById('itemNotes').value = '';
                document.getElementById('daySelector').classList.remove('hidden');
            },

            cancelForm() {
                this.editingId = null;
                this.toggleForm();
            },

            editItem(id) {
                const item = this.items.find(i => i.id === id);
                if (!item) return;

                this.editingId = id;
                document.getElementById('itemName').value = item.name;
                document.getElementById('itemAmount').value = item.amount;
                document.getElementById('itemCategory').value = item.category;
                document.getElementById('itemType').value = item.type;
                document.getElementById('itemDay').value = item.dayOfMonth || 1;
                document.getElementById('itemPayment').value = item.payment || '';
                document.getElementById('itemNotes').value = item.notes || '';
                
                this.toggleDaySelector();
                
                document.getElementById('formTitle').textContent = 'Edit Item';
                document.getElementById('saveBtn').textContent = 'Save Changes';
                document.getElementById('addForm').classList.remove('hidden');
            },

            duplicateItem(id) {
                const item = this.items.find(i => i.id === id);
                if (!item) return;

                this.items.push({
                    ...item,
                    id: Date.now(),
                    name: item.name + ' (Copy)'
                });

                this.invalidateCache();
                this.render();
                this.updateChart();
                this.updateDashboard();
                lucide.createIcons();
            },

            toggleItemSelection(id) {
                if (this.selectedItems.has(id)) {
                    this.selectedItems.delete(id);
                } else {
                    this.selectedItems.add(id);
                }
                this.updateBulkActionsBar();
                this.render();
            },

            updateBulkActionsBar() {
                const bar = document.getElementById('bulkActionsBar');
                const count = document.getElementById('selectedCount');
                count.textContent = this.selectedItems.size;
                
                if (this.selectedItems.size > 0) {
                    bar.classList.remove('hidden');
                } else {
                    bar.classList.add('hidden');
                }
            },

            bulkDelete() {
                if (this.selectedItems.size === 0) return;
                
                if (confirm(`Delete ${this.selectedItems.size} selected items?`)) {
                    this.items = this.items.filter(item => !this.selectedItems.has(item.id));
                    this.selectedItems.clear();
                    this.invalidateCache();
                    this.updateBulkActionsBar();
                    this.render();
                    this.updateChart();
                    this.updateDashboard();
                    lucide.createIcons();
                }
            },

            clearSelection() {
                this.selectedItems.clear();
                this.updateBulkActionsBar();
                this.render();
            },

            showExportMenu() {
                const menu = document.getElementById('exportMenu');
                menu.classList.toggle('hidden');
                document.getElementById('addForm').classList.add('hidden');
            },

            toggleDaySelector() {
                const type = document.getElementById('itemType').value;
                const daySelector = document.getElementById('daySelector');
                daySelector.classList.toggle('hidden', type === 'one-time');
            },

            applyFilters() {
                if (this.renderTimeout) {
                    clearTimeout(this.renderTimeout);
                }
                this.renderTimeout = setTimeout(() => {
                    this.render();
                }, 150);
            },

            getFilteredItems() {
                const search = document.getElementById('searchInput').value.toLowerCase();
                const categoryFilter = document.getElementById('categoryFilter').value;
                const sortBy = document.getElementById('sortBy').value;

                const filtered = [];
                for (let i = 0; i < this.items.length; i++) {
                    const item = this.items[i];
                    
                    if (item.type !== this.currentTab) continue;
                    if (search && !item.name.toLowerCase().includes(search)) continue;
                    if (categoryFilter && item.category !== categoryFilter) continue;
                    
                    filtered.push(item);
                }

                if (sortBy === 'name') {
                    filtered.sort((a, b) => a.name.localeCompare(b.name));
                } else if (sortBy === 'amount-high') {
                    filtered.sort((a, b) => b.amount - a.amount);
                } else if (sortBy === 'amount-low') {
                    filtered.sort((a, b) => a.amount - b.amount);
                } else if (sortBy === 'day' && this.currentTab === 'recurring') {
                    filtered.sort((a, b) => (a.dayOfMonth || 0) - (b.dayOfMonth || 0));
                }

                return filtered;
            },

            switchTab(tab) {
                this.currentTab = tab;
                
                const recurringTab = document.getElementById('tabRecurring');
                const oneTimeTab = document.getElementById('tabOneTime');
                
                if (tab === 'recurring') {
                    recurringTab.classList.remove('text-gray-600', 'dark:text-gray-400', 'border-transparent');
                    recurringTab.classList.add('text-gray-900', 'dark:text-white', 'border-blue-600', 'dark:border-blue-400');
                    oneTimeTab.classList.remove('text-gray-900', 'dark:text-white', 'border-blue-600', 'dark:border-blue-400');
                    oneTimeTab.classList.add('text-gray-600', 'dark:text-gray-400', 'border-transparent');
                } else {
                    oneTimeTab.classList.remove('text-gray-600', 'dark:text-gray-400', 'border-transparent');
                    oneTimeTab.classList.add('text-gray-900', 'dark:text-white', 'border-blue-600', 'dark:border-blue-400');
                    recurringTab.classList.remove('text-gray-900', 'dark:text-white', 'border-blue-600', 'dark:border-blue-400');
                    recurringTab.classList.add('text-gray-600', 'dark:text-gray-400', 'border-transparent');
                }
                
                this.render();
            },

            saveItem() {
                const name = document.getElementById('itemName').value;
                const amount = parseFloat(document.getElementById('itemAmount').value);
                const category = document.getElementById('itemCategory').value;
                const type = document.getElementById('itemType').value;
                const dayOfMonth = type === 'recurring' ? parseInt(document.getElementById('itemDay').value) : null;
                const payment = document.getElementById('itemPayment').value;
                const notes = document.getElementById('itemNotes').value;

                if (!name || !amount) {
                    alert('Please fill in required fields');
                    return;
                }

                if (this.editingId) {
                    const index = this.items.findIndex(i => i.id === this.editingId);
                    if (index !== -1) {
                        this.items[index] = {
                            ...this.items[index],
                            name,
                            amount,
                            category,
                            type,
                            dayOfMonth,
                            payment,
                            notes
                        };
                    }
                    this.editingId = null;
                } else {
                    this.items.push({
                        id: Date.now(),
                        name,
                        amount,
                        category,
                        type,
                        dayOfMonth,
                        payment,
                        notes
                    });
                }

                this.invalidateCache();
                this.clearForm();
                this.toggleForm();
                this.render();
                this.updateChart();
                this.updateDashboard();
                lucide.createIcons();
            },

            deleteItem(id) {
                if (confirm('Delete this item?')) {
                    this.items = this.items.filter(item => item.id !== id);
                    this.selectedItems.delete(id);
                    this.invalidateCache();
                    this.updateBulkActionsBar();
                    this.render();
                    this.updateChart();
                    this.updateDashboard();
                    lucide.createIcons();
                }
            },

            setChartType(type) {
                this.chartType = type;
                
                const barBtn = document.getElementById('barChartBtn');
                const pieBtn = document.getElementById('pieChartBtn');
                
                if (type === 'bar') {
                    barBtn.className = 'px-3 py-1 text-sm bg-blue-600 dark:bg-blue-500 text-white rounded font-semibold';
                    pieBtn.className = 'px-3 py-1 text-sm bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded font-semibold';
                } else {
                    pieBtn.className = 'px-3 py-1 text-sm bg-blue-600 dark:bg-blue-500 text-white rounded font-semibold';
                    barBtn.className = 'px-3 py-1 text-sm bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded font-semibold';
                }
                
                this.updateChart();
            },

            updateChart() {
                const ctx = document.getElementById('categoryChart');
                const categoryTotals = this.getCategoryTotals();

                const labels = Object.keys(categoryTotals);
                const data = Object.values(categoryTotals);
                const isDark = this.theme === 'dark';

                if (this.chart) {
                    this.chart.destroy();
                }

                const chartConfig = {
                    type: this.chartType,
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Spending by Category',
                            data: data,
                            backgroundColor: this.chartType === 'pie' 
                                ? ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899']
                                : (isDark ? 'rgba(59, 130, 246, 0.8)' : 'rgba(37, 99, 235, 0.8)'),
                            borderColor: isDark ? 'rgba(147, 197, 253, 1)' : 'rgba(29, 78, 216, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        animation: {
                            duration: 300
                        },
                        plugins: {
                            legend: {
                                display: this.chartType === 'pie',
                                position: 'right',
                                labels: {
                                    color: isDark ? '#e5e7eb' : '#374151',
                                    font: {
                                        weight: 'bold'
                                    }
                                }
                            }
                        },
                        scales: this.chartType === 'bar' ? {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toFixed(0);
                                    },
                                    color: isDark ? '#e5e7eb' : '#374151',
                                    font: {
                                        weight: 'bold'
                                    }
                                },
                                grid: {
                                    color: isDark ? '#4b5563' : '#d1d5db'
                                }
                            },
                            x: {
                                ticks: {
                                    color: isDark ? '#e5e7eb' : '#374151',
                                    font: {
                                        weight: 'bold'
                                    }
                                },
                                grid: {
                                    color: isDark ? '#4b5563' : '#d1d5db'
                                }
                            }
                        } : {}
                    }
                };

                this.chart = new Chart(ctx, chartConfig);
            },

            updateDashboard() {
                const top5 = [...this.items]
                    .sort((a, b) => b.amount - a.amount)
                    .slice(0, 5);
                
                const topExpensiveHTML = top5.length > 0 ? top5.map((item, index) => `
                    <div class="flex items-center justify-between p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <div class="flex items-center gap-2">
                            <span class="text-lg font-bold text-gray-500 dark:text-gray-400">${index + 1}</span>
                            <span class="text-lg">${this.categoryIcons[item.category] || 'üì¶'}</span>
                            <div>
                                <div class="font-bold text-gray-900 dark:text-white">${item.name}</div>
                                <div class="text-xs font-medium text-gray-600 dark:text-gray-400">${item.category}</div>
                            </div>
                        </div>
                        <span class="font-bold text-gray-900 dark:text-white">$${item.amount.toFixed(2)}</span>
                    </div>
                `).join('') : '<p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4 font-medium">No items yet</p>';
                
                document.getElementById('topExpensiveItems').innerHTML = topExpensiveHTML;

                const stats = this.getStats();
                const recurringTotal = stats.monthlyTotal;
                
                let oneTimeSum = 0;
                let oneTimeCount = 0;
                for (let i = 0; i < this.items.length; i++) {
                    if (this.items[i].type === 'one-time') {
                        oneTimeSum += this.items[i].amount;
                        oneTimeCount++;
                    }
                }
                
                const oneTimeAverage = oneTimeCount > 0 ? oneTimeSum / 3 : 0;
                const forecastTotal = recurringTotal + oneTimeAverage;
                
                document.getElementById('forecastRecurring').textContent = `$${recurringTotal.toFixed(2)}`;
                document.getElementById('forecastOneTime').textContent = `$${oneTimeAverage.toFixed(2)}`;
                document.getElementById('forecastTotal').textContent = `$${forecastTotal.toFixed(2)}`;
                
                const note = oneTimeCount > 0 
                    ? `Based on average of ${oneTimeCount} one-time purchase(s)`
                    : 'No one-time purchase history for prediction';
                document.getElementById('forecastNote').textContent = note;
            },exportCSV() {
                const headers = ['Name', 'Amount', 'Category', 'Type', 'Day of Month', 'Payment', 'Notes'];
                const rows = this.items.map(item => [
                    item.name,
                    item.amount,
                    item.category,
                    item.type,
                    item.dayOfMonth || 'N/A',
                    item.payment || '',
                    item.notes || ''
                ]);

                let csvContent = headers.join(',') + '\n';
                rows.forEach(row => {
                    csvContent += row.map(field => `"${field}"`).join(',') + '\n';
                });

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `lazare-trackt-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                document.getElementById('exportMenu').classList.add('hidden');
            },

            exportJSON() {
                const backup = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    budget: this.budget,
                    items: this.items
                };

                const json = JSON.stringify(backup, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `lazare-trackt-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                document.getElementById('exportMenu').classList.add('hidden');
            },

            importJSON(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const backup = JSON.parse(e.target.result);
                        
                        if (!backup.items || !Array.isArray(backup.items)) {
                            throw new Error('Invalid backup file format');
                        }

                        const merge = confirm('Merge with existing data? Click Cancel to replace all data.');
                        
                        if (merge) {
                            backup.items.forEach(item => {
                                this.items.push({
                                    ...item,
                                    id: Date.now() + Math.random()
                                });
                            });
                        } else {
                            this.items = backup.items;
                            if (backup.budget) {
                                this.budget = backup.budget;
                                document.getElementById('budgetInput').value = backup.budget;
                            }
                        }

                        this.invalidateCache();
                        this.render();
                        this.updateChart();
                        this.updateDashboard();
                        lucide.createIcons();
                        alert('JSON backup imported successfully!');
                    } catch (error) {
                        alert('Error importing JSON: ' + error.message);
                    }
                };
                reader.readAsText(file);
                
                event.target.value = '';
            },

            importCSV(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const lines = text.split('\n');
                    
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;

                        const matches = line.match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g);
                        if (!matches || matches.length < 4) continue;

                        const [name, amount, category, type, dayOfMonth, payment, notes] = matches.map(field => 
                            field.replace(/^"|"$/g, '').trim()
                        );

                        this.items.push({
                            id: Date.now() + i,
                            name,
                            amount: parseFloat(amount),
                            category,
                            type,
                            dayOfMonth: dayOfMonth && dayOfMonth !== 'N/A' ? parseInt(dayOfMonth) : null,
                            payment: payment || '',
                            notes: notes || ''
                        });
                    }

                    this.invalidateCache();
                    this.render();
                    this.updateChart();
                    this.updateDashboard();
                    lucide.createIcons();
                    alert('CSV imported successfully!');
                };
                reader.readAsText(file);
                
                event.target.value = '';
            },

            exportPDF(period) {
                const recurringItems = this.items.filter(item => item.type === 'recurring');
                const oneTimeItems = this.items.filter(item => item.type === 'one-time');
                
                const monthlyTotal = recurringItems.reduce((sum, item) => sum + item.amount, 0);
                const yearlyTotal = period === 'yearly' ? monthlyTotal * 12 : monthlyTotal;
                const oneTimeTotal = oneTimeItems.reduce((sum, item) => sum + item.amount, 0);

                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Lazare Trackt - ${period === 'yearly' ? 'Yearly' : 'Monthly'} Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 40px; color: #000; }
                            h1 { font-size: 24px; margin-bottom: 10px; }
                            .subtitle { color: #666; margin-bottom: 30px; }
                            .summary { background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
                            .summary-item { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 16px; }
                            .summary-item strong { font-weight: 600; }
                            h2 { font-size: 18px; margin-top: 30px; margin-bottom: 15px; border-bottom: 2px solid #000; padding-bottom: 5px; }
                            table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                            th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
                            th { background: #f5f5f5; font-weight: 600; }
                            .footer { margin-top: 50px; text-align: center; color: #666; font-size: 12px; }
                        </style>
                    </head>
                    <body>
                        <h1>Lazare Trackt Report</h1>
                        <div class="subtitle">${period === 'yearly' ? 'Annual' : 'Monthly'} Expense Summary - ${new Date().toLocaleDateString()}</div>
                        
                        <div class="summary">
                            <div class="summary-item"><span>Total Items:</span><strong>${this.items.length}</strong></div>
                            <div class="summary-item"><span>${period === 'yearly' ? 'Annual' : 'Monthly'} Recurring:</span><strong>$${yearlyTotal.toFixed(2)}</strong></div>
                            <div class="summary-item"><span>One-Time Purchases:</span><strong>$${oneTimeTotal.toFixed(2)}</strong></div>
                            <div class="summary-item" style="font-size: 18px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                                <span>Grand Total:</span><strong>$${(yearlyTotal + oneTimeTotal).toFixed(2)}</strong>
                            </div>
                        </div>

                        ${recurringItems.length > 0 ? `
                            <h2>Recurring Items</h2>
                            <table>
                                <thead><tr><th>Item</th><th>Category</th><th>Day</th><th>Monthly</th>${period === 'yearly' ? '<th>Yearly</th>' : ''}</tr></thead>
                                <tbody>
                                    ${recurringItems.map(item => `
                                        <tr><td>${item.name}</td><td>${item.category}</td><td>Day ${item.dayOfMonth}</td><td>$${item.amount.toFixed(2)}</td>${period === 'yearly' ? `<td>$${(item.amount * 12).toFixed(2)}</td>` : ''}</tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        ` : ''}

                        ${oneTimeItems.length > 0 ? `
                            <h2>One-Time Purchases</h2>
                            <table>
                                <thead><tr><th>Item</th><th>Category</th><th>Amount</th></tr></thead>
                                <tbody>
                                    ${oneTimeItems.map(item => `<tr><td>${item.name}</td><td>${item.category}</td><td>$${item.amount.toFixed(2)}</td></tr>`).join('')}
                                </tbody>
                            </table>
                        ` : ''}

                        <div class="footer">Generated by Lazare Trackt on ${new Date().toLocaleString()}</div>
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
                setTimeout(() => { printWindow.print(); }, 250);
                
                document.getElementById('exportMenu').classList.add('hidden');
            },

            render() {
                const stats = this.getStats();

                document.getElementById('monthlyTotal').textContent = `$${stats.monthlyTotal.toFixed(2)}`;
                document.getElementById('yearlyTotal').textContent = `$${stats.yearlyTotal.toFixed(2)}`;
                document.getElementById('oneTimeTotal').textContent = `$${stats.oneTimeTotal.toFixed(2)}`;
                document.getElementById('itemCount').textContent = stats.itemCount;

                this.checkBudgetAlert();

                const filteredItems = this.getFilteredItems();
                const htmlParts = [];

                for (let i = 0; i < filteredItems.length; i++) {
                    const item = filteredItems[i];
                    const isSelected = this.selectedItems.has(item.id);
                    
                    htmlParts.push(`
                        <div class="border-2 border-gray-300 dark:border-gray-600 rounded-lg p-4 mb-3 hover:border-blue-400 dark:hover:border-blue-500 transition-colors ${isSelected ? 'bg-blue-50 dark:bg-blue-900/30 border-blue-400 dark:border-blue-500' : 'bg-white dark:bg-gray-700/50'}">
                            <div class="flex items-start justify-between">
                                <div class="flex items-start gap-3 flex-1">
                                    <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="app.toggleItemSelection(${item.id})" class="mt-1 w-4 h-4 cursor-pointer accent-blue-600">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="text-lg">${this.categoryIcons[item.category] || 'üì¶'}</span>
                                            <h3 class="font-bold text-gray-900 dark:text-white">${item.name}</h3>
                                            <span class="text-xs px-2 py-1 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded font-semibold">${item.category}</span>
                                        </div>
                                        <div class="flex items-center gap-4 text-sm text-gray-700 dark:text-gray-300 mb-2 font-medium">
                                            <span class="flex items-center gap-1"><i data-lucide="dollar-sign" class="w-4 h-4"></i>$${item.amount.toFixed(2)}${item.type === 'recurring' ? '/month' : ''}</span>
                                            ${item.type === 'recurring' ? `<span class="flex items-center gap-1"><i data-lucide="calendar" class="w-4 h-4"></i>Day ${item.dayOfMonth}</span><span class="text-gray-500 dark:text-gray-400">$${(item.amount * 12).toFixed(2)}/year</span>` : ''}
                                            ${item.payment ? `<span class="flex items-center gap-1"><i data-lucide="credit-card" class="w-4 h-4"></i>${item.payment}</span>` : ''}
                                        </div>
                                        ${item.notes ? `<div class="text-sm text-gray-600 dark:text-gray-400 italic font-medium">${item.notes}</div>` : ''}
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="app.editItem(${item.id})" class="text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 transition-colors p-2"><i data-lucide="edit-2" class="w-5 h-5"></i></button>
                                    <button onclick="app.duplicateItem(${item.id})" class="text-gray-500 hover:text-green-600 dark:text-gray-400 dark:hover:text-green-400 transition-colors p-2"><i data-lucide="copy" class="w-5 h-5"></i></button>
                                    <button onclick="app.deleteItem(${item.id})" class="text-gray-500 hover:text-red-600 dark:text-gray-400 dark:hover:text-red-400 transition-colors p-2"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                                </div>
                            </div>
                        </div>
                    `);
                }

                const itemsHTML = htmlParts.length > 0 ? htmlParts.join('') : `
                    <div class="text-center py-12 text-gray-500 dark:text-gray-400">
                        <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-3"></i>
                        <p class="font-semibold">No ${this.currentTab} items yet</p>
                    </div>
                `;

                document.getElementById('itemsList').innerHTML = itemsHTML;
                lucide.createIcons();
            }
        };

        app.init();
    </script>
</body>
</html>
